<include file="__THEME__/public_header_twolevel"/>

<!--content start-->
    <div class="body">
        <div class="classtop">
            <div class="img-box">
                <img src="{:cutImg($data['cover'] ,640 , 340 )}" alt="" />
            </div>
            <div class="info">
                <h3>{$data.video_title}</h3>
                <div class="num">已购买：{$data.video_order_count}人<span>|</span>课时数：共{$data['sectionNum']}节</div>
                <div class="xx" style="margin-top:20px"><small>原价：<span>¥{$data['mzprice']['oriPrice']}</span></small></div>
                <div class="xx">
                    <div class="price">优惠价：<span>¥{$data['mzprice']['price']}</span></div>
                </div>
                <div class="xx" style="margin-top: 10px;">
                    <div class="fx fr">
                        <a href="javascript:;" onClick="shareVideo(this,{$vid})"><i class="icon-02"></i></a>
                    </div>
                    <div class="sc fr">
                        <php>if($data['iscollect']){</php>
                        <a href="javascript:;" onClick="collectVideo(this,{$vid},0)"><i class="icon-01 hover"></i></a>
                        <php>}else{</php>
                        <a href="javascript:;" onClick="collectVideo(this,{$vid},1)"><i class="icon-01"></i></a>
                        <php>}</php>
                    </div>
                    <div class="btn">
                        <php>if($data['is_buy']){</php>
                        <a href="{:U('classroom/Video/watch',array('id'=>$_GET['id'],'s_id'=>$s_id))}" class="learn">开始学习</a>
                        <php>}else{</php>
                        <form action="{:U('classroom/PayVideo/index')}" method="POST" id="pay_form">
                            <input type="hidden" value="{$data['id']}" name="vid" />
                            <input type="hidden" value="zy_video" name="check_type" />
                            <input type="hidden" value="课程：{$data['video_title']}" name="title" />
                            <input type="hidden" id="money" value="{$data['mzprice']['price']}" name="money" />
                        </form>
                        <a class="buy" href="javascript:void(0);" id="charge_video">立即购买</a>
                        <php>}</php>
                    </div>
                </div>
                <!--<div class="txt">{$data.video_binfo}</div>-->
            </div>
        </div>

        <div class="classbot">
            <div class="classmain-hd classmain-ul">
                <ul>
                    <li class="choose on"><a href="javascript:;">简介</a></li>
                    <li class="choose"><a href="javascript:;">目录</a></li>
                    <!--<li><a href="javascript:;">提问</a></li>-->
                    <!--<li><a href="javascript:;">笔记</a></li>-->
                    <!--<li><a href="javascript:;">点评</a></li>-->
                </ul>
            </div>
            <div class="classmain-bd videoInfo" style="display: block;">
                <div class="classmain_con">
                    <div class="classitem">
                        <div class="classtit">课程简介</div>
                        <div class="classcon" style="font-size: 14px;">{$data.video_intro}</div>
                    </div>

                    <php>if($mhmData){</php>
                        <div class="classitem">
                            <div class="classtit">机构信息</div>
                            <div class="classcon">
                                <dl class="class_jg_dl">
                                    <dt><a href="{$mhmData.domain}"><img src="{$mhmData['logo']}" alt=""></a></dt>
                                    <dd>
                                        <h3>
                                            <a href="{$mhmData.domain}">{$mhmData['title']}<!--<span class="icon-star"></span>--></a>
                                            <div class="class_jg_btn">
                                                <!--<a href="{$mhmData.domain}">进入机构</a>-->
                                                <php>if($mhmData['state']['following']){</php>
                                                <a href="javascript:;" onclick="setFollow({$mhmData['uid']}, false)">已关注</a>
                                                <php>}else{</php>
                                                <a href="javascript:;" onclick="setFollow({$mhmData['uid']}, true)">+关注</a>
                                                <php>}</php>
                                            </div>
                                        </h3>
                                        <!--<div class="new_tags">{:limitNumber($mhmData['str_tag'],15)}</div>-->
                                        <ul class="class_jg_ul">
                                            <li>好评度：{$mhmData.favorable_rate}</li>
                                            <li>课程数：{$mhmData.count}</li>
                                        </ul>
                                    </dd>
                                </dl>
                                <div class="class_jg_txt">{:msubstr(t($mhmData['info']),0,50,'utf-8',true)}</div>
                            </div>
                        </div>
                    <php>}</php>
                    
                    <php>if($data['user']){</php>
                    <div class="classitem">
                        <div class="classtit">讲师简介</div>
                        <li class="classcon">
                            <dl class="class_js_dl">
                                <dt><a href="{:U('classroom/Teacher/view',array('id'=>$data['user']['id']))}"><img src="{:getCover($data['user']['head_id'],266,170)}" alt=""></a></dt>
                                <dd>
                                    <h3>
                                        <a href="javascript:;">{$data.user.name}</a>
                                        <div class="class_jg_btn">
                                            <!--<a href="{:U('classroom/Teacher/view',array('id'=>$data['user']['id']))}">查看讲师</a>-->
                                            <php>if($data['user']['fans_state']){</php>
                                            <a href="javascript:;">已关注</a>
                                            <php>}else{</php>
                                            <a href="javascript:;" onclick="followyou(this,{$data['user']['uid']},{$data['user']['id']})">+关注</a>
                                            <php>}</php>
                                        </div>
                                    </h3>
                                    <!--<div class="tag">{:limitNumber($data['user']['label'],15)}</div>-->
                                    <ul class="class_jg_ul">
                                        <li>课程数：{$video_count}</li>
                                        <li class="info">学生数：{$follow}</li>
                                    </ul>
                                </dd>
                            </dl>
                            <div class="class_js_txt">{:msubstr(t($data['user']['inro']),0,200,'utf-8',true)}</div>
                        </div>
                    </div>
                    <php>}</php>
                    
                    <!--<php>if($source){</php>
                    <div class="classitem">
                        <div class="classtit"><em></em>他们也关注了</div>
                        <div class="classcon">
                            <ul class="class_mb_ul">
                                <volist name="source" id="vol">
                                    <li>
                                        &lt;!&ndash;<a href="{:U('classroom/UserShow/index',array('uid'=>$vol['uid']))}">&ndash;&gt;
                                            <img src="{$vol['user']['avatar_big']}" alt="{$vol['user']['uname']}">
                                            <p>{$vol['user']['uname']}</p>
                                        &lt;!&ndash;</a>&ndash;&gt;
                                    </li>
                                </volist>
                            </ul>
                        </div>
                    </div>
                    <php>}</php>-->
                </div>
            </div>

            <div class="classmain-bd videoInfo" style="display: none;">
                <div class="classmain_con">
                    <php>if(!$video_section_data){</php><p style="font-size:14px;padding: 20px;">该课程暂时没有目录</p><php>}else{</php>
                      <volist name="video_section_data" id="vo">
                        <dl class="class_directory">
                            <dt>{:msubstr(t($vo['title']),0,15,'utf-8',true)}</dt>
                            <php>if($vo['child']){</php>
                                <volist name="vo.child" id="vo1">
                                    <dd>
                                        <a href="{:U('classroom/Video/watch','id='.$vo1['vid'].'&s_id='.$vo1['id'])}">
                                            <php>if($vo1['video_type'] == 1){</php>
                                                <em style="background: #7ebdff;">视频</em>
                                            <php>}else if($vo1['video_type'] == 2){</php>
                                                <em style="background: #78deaa;">音频</em>
                                            <php>}else if($vo1['video_type'] == 3){</php>
                                                <em style="background: #88b2cc;">文本</em>
                                            <php>}else if($vo1['video_type'] == 4){</php>
                                                <em style="background: #88b2cc;">文档</em>
                                            <php>}</php>

                                            <php>if($vo1['is_free'] == 1){</php>
                                                <em style="background: #ffba6f;">试听</em>
                                            <php>}else if($video['is_charge'] == 1){</php>
                                                <em style="background: #39b75d;" >免费</em>
                                            <php>}</php>
                                            <span>{:limitNumber($vo1['title'],10)}</span>
                                            <span><i class="icon-01"></i></span>
                                        </a>
                                    </dd>
                                </volist>
                            <php>}</php>
                        </dl>
                    </volist>
                    <php>}</php>
                </div>
            </div>
        </div>
    </div>

<script type="text/javascript">
   var  uid = '{$uid}';
   var  mid = '{$uid}';

     //导航选择卡
    $(".choose").click(function(){
        $(this).addClass("on").siblings().removeClass("on");
        var index = $(this).index();
        $(".videoInfo").hide().eq(index).show();
    });

   function randomString(len) {
       len = len || 32;
       var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';    /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/
       var maxPos = $chars.length;
       var pwd = '';
       for (i = 0; i < len; i++) {
           pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
       }
       return pwd;
   }

   //购买操作
   $('#charge_video').click(function () {

       if(uid<=0){
           if(confirm("请先登录")){
               var mhm_id='{$this_mhm_id}';
               if(mhm_id){
                   window.location.href  = "{:U('public/Passport/login_g')}"+'?'+'this_mhm_id'+'='+mhm_id;
               }else{
                   window.location.href = "{:U('public/Passport/login_g')}";
               }
           }
           return false;
       }
       var form  = $('#pay_form');
       var vid = form.find('input:hidden[name="vid"]').val();
       var vtype = form.find('input:hidden[name="check_type"]').val();

       if(!vid || !vtype){
           alert('参数错误');
           return false;
       }

       var rechange_base = parseFloat('{:getAppConfig("rechange_basenum")}');
       var money = form.find('input:hidden[name="money"]').val();

       if(money <= 0){
           if(confirm('该直播课程需要加入我的看单后方可学习，确定加入？')){
               var form  = $('#pay_form');
               var vid = form.find('input:hidden[name="vid"]').val();
               var vtype = form.find('input:hidden[name="check_type"]').val();

               $.post(U("classroom/PayVideo/add_order"),{vid:vid,vtype:vtype},function(data){
                   if(data.status == 1){
                       $('.message_add_order_box').hide();
                       alert(data.info);
                       window.location.reload();
                   } else {
                       alert(data.info);
                       return false;
                   }
               },'json');
           }
//           $('.message_add_order_box').show();
//           $('.mask').show();
           return false;
       }
       if(rechange_base>0 && money%rechange_base != 0){
           if(rechange_base == 1){
               alert('购买金额必须为整数');
           }else{
               alert('购买金额必须为'+rechange_base+'的倍数');
           }
           return false;
       }

       $.post(U("classroom/PayVideo/checkPay"),$('#pay_form').serialize(),function(data){
           var mount_url = "{$_GET['mid']}";
           if(data.status == 1){
               if(mount_url){
                   window.location.href = '/pay/'+vid+"%2C"+vtype+"%2C"+mount_url+"%2C"+randomString(2)+".html";
//                    window.location.href = "{:U('classroom/PayVideo/index')}"+"&vst="+vid+"%2C"+vtype+"%2C"+mount_url+"%2C"+randomString(2);
               }else{
                   window.location.href = '/pay/'+vid+"%2C"+vtype+"%2C"+randomString(2)+".html";
//                    window.location.href = "{:U('classroom/PayVideo/index')}"+"&vst="+vid+"%2C"+vtype+"%2C"+randomString(2);
               }
           } else if(data.status == 9){
               alert(data.info);
               window.location.reload();
           } else {
               alert(data.info);
               return false;
           }
       },'json');
   });

    function setFollow(uid, follow){
        if(mid <=0){
            if(confirm("请先登录")){
                window.location.href = "{:U('public/Passport/login_g')}";
            }
            return false;
        }
        action = follow?'doFollowMhm':'unFollow';
        $.post(U('public/Follow/'+action), {fid:uid}, function(data){
            if(data.status){
                alert('操作成功');
                setTimeout('window.location.reload()', 1000);
            }else{
                alert(data.info);
            }
        }, 'json');
    }

    //关注讲师
    function followyou(cate,uid,id){

        if(mid <=0){
            if(confirm("请先登录")){
                window.location.href = "{:U('public/Passport/login_g')}";
            }
            return false;
        }
        $.ajax({
            type: "POST",
            url:"{:U('classroom/Public/followyou')}",
            data:"fid="+uid+"&tid="+id,
            dataType:"json",
            success:function(data){
                if(data.status=='0'){
                    alert(data.info);
                    return;
                }else{
                    setTimeout('window.location.reload()', 1000);
                }

            }
        });
    }

    //收藏课程
    function collectVideo(cate,vid,type){
        if(uid<=0){
            if(confirm("请先登录")){
                window.location.href = "{:U('public/Passport/login_g')}";
            }
            return false;
        }

        $.ajax({
            type: 'POST',
            url:"{:U('classroom/Public/collect')}",
            data:{type:type,sctype:2,source_id:vid,is_video:1},
            dataType:"json",
            cache: false,
            success: function(data){
                if(data.status == '0'){
                   alert(data.info);
                } else {
                    alert(data.info);
                    window.location.reload();
                }
            },
        });
    }


   //分享
   function shareVideo(obj,vid) {

       if(uid<=0){
           if(confirm("请先登录")){
               window.location.href = "{:U('public/Passport/login_g')}";
           }
           return false;
       }

       if(!vid){
          alert("参数错误");
           return false;
       }
       $.post("{:U('classroom/VideoShare/addVideoShare')}", {vid:vid,type:0}, function (e) {
           if(e.status == 1){
               e.allinfo ="分享成功！您的分享链接为："+e.info;
               if(!confirm(e.allinfo)){
                   return false;
               }
                   $('#urlcopy').val(e.info);
                   var text=document.getElementById("urlcopy");
                   text.select(); // 选择对象
                   document.execCommand("Copy"); // 执行浏览器复制命令
                   window.location.reload();
//                   alert("你已经成功复制链接！");
           }else{
               alert(e.info);
           }
       }, 'json');
   }

</script>
<!--footer-->
<include file="__THEME__/public_footer_twolevel"/>
<!--<input type ="text"   id="urlcopy"   style="border:1px;border-bottom-style:none;border-top-style:none;border-left-style:none;border-right-style:none;"  >-->
