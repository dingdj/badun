<include file="__THEME__/_header_w3g" />

<script>
    var CLICK_VERIFY="{:U('public/Passport/clickVerify')}";
    var CLICK_UNAME="{:U('public/Passport/clickUname')}";
    var CLICK_PHONE="{:U('public/Passport/clickPhone')}";
    var CLICK_PHONEVER="{:U('public/Passport/clickPhoneVer')}";
    var SETUSERFACE="{:U('public/Passport/setUserFace')}";
    var GET_PHONEVERIFY="{:U('public/Passport/getVerify')}";
    //异步注册地址
    var REG_ADDRESS="{:U('public/Passport/ajaxReg')}";

    //更换验证码
    function changeverify(){
        var date = new Date();
        var ttime = date.getTime();
        var url = "__ROOT__/public/captcha.php";
        $('#verifyimg').attr('src',url+'?'+ttime);

    };
</script>

  <div class="loginbox" >
    	<a class="icon-colse" href="/"></a>
        <div class="login_logo"><img src="{$site.logo_head_w3g}" alt=""/></div>
        <div class="login-hd">
        	<li><a href="{:U('public/Passport/login_g')}">登录</a></li>
            <li>·</li>
            <li class="on"><a href="javascript:;">注册</a></li>
        </div>
        <p style="margin-bottom: 10px;"><a href="javascript:;" onclick="phoneReg(this)">手机注册</a>&nbsp;或者&nbsp;<a href="javascript:;" onclick="emailReg(this)">邮箱注册</a></p>
        <div class="login-bd" id="phoneReg" style="display: block;">
        	<div class="item code">
            	<div class="num"><select><option>+86</option></select></div>
            	<input type="text" id="prphone" placeholder="请输入手机号">
            </div>
            <div class="item">
            	<input type="text" id="prverify" placeholder="请输入手机验证码">
                <a class="yzm" href="javascript:;" onclick="getPhoneVerify()">获取验证码</a>
            </div>
            <div class="item">
            	<input type="password" id="prpassword" placeholder="请输入密码">
            </div>
            <div class="item">
                <input type="password" id="prpassword2" placeholder="确认密码">
            </div>
            <a class="login_btn" href="javascript:;" onclick="phoneNext()">注册</a>
            <!--<p>点击注册即代表您同意<a href="{:U('public/Single/info',array('id'=>35))}">《{$site['site_keyword']}服务协议》</a></p>-->
            <p>点击注册即代表您同意<a href="javascript:;">《{$site['site_keyword']}服务协议》</a></p>
        </div>
        <div class="login-bd" id="emailReg" style="display: none;">
            <div class="item">
                <input type="text" id="erusername" placeholder="请输入邮箱地址">
            </div>
            <div class="item">
                <input type="text" id="erverify" placeholder="请输入右侧验证码">
                <img class="yzm-3g" src="__ROOT__/public/captcha.php" title="点击刷新" onclick="changeverify()" id="verifyimg">
            </div>
            <div class="item">
                <input type="password" id="erpasswrod" placeholder="请输入密码">
            </div>
            <div class="item">
                <input type="password" id="erpasswrod2" placeholder="确认密码">
            </div>
            <a class="login_btn" href="javascript:;" onclick="onemaliNext()">注册</a>
            <p>点击注册即代表您同意<a href="javascript:;">《{$site['site_keyword']}服务协议》</a></p>
        </div>

  </div>
    <!--用户信息-->
    <div class="loginbox login_nextbox" style="display: none;">
    <div class="title" style="padding-bottom: 10px;font-size: 20px;line-height: 20px;color: #333;border-bottom: solid 1px #eee;"><em></em>完善信息，让学友们更了解你</div>
    <form class="loginform">
        <div class="login-bd">
            <div class="item">
                <input type="text" id="uname" maxlength="6" placeholder="请输入用户昵称">
            </div>
            <div class="item">
                <select name="interest" id="sex">
                    <option value="1">男</option>
                    <option value="2">女</option>
                </select>
            </div>
            <div class="item">
                <style>
                    select {
                        width: 83px !important;
                        border-radius: 4px;
                        border: solid 1px #b6c7d6;
                        line-height: 34px;
                    }
                </style>
                {:W('Area',array('curPro'=>$user['province'],'curCity'=>$user['city'],'area'=>$user['area'],'city_names'=>$user['location'],'tpl'=>'zyCardArea'))}
            </div>
            <div class="item">
                <input type="text" id="profession" maxlength="10" placeholder="请输入您的职业,10个字符内">
            </div>
            <div class="item">
                <select name="interest" id="interest">
                        <option value="0">感兴趣</option>
                    <foreach name="interest" item="vo" key="k">
                        <option value="{$vo.zy_currency_category_id}">{$vo.title}</option>
                    </foreach>
                </select>
            </div>
            <div class="item" style="height: auto;">
                <textarea id="intro" style="width:100%; height: 90px;" maxlength="500" placeholder="请输入个人简介,6-500个字符内" cols="" rows=""></textarea>
            </div>
        </div>
        <a class="login_btn" href="javascript:;" onclick="setUserInfo()">完成填写，注册！</a>
        <a href="javascript:;" style="font-size: 16px;" onclick="prevBang()">返回</a>
    </form>
</div>


<script>
    $(function(){
        $("#preloader").hide();
    });
    //手机注册
    function phoneReg(cate){
        $(cate).addClass("f3");
        $(cate).prev().removeClass();
        $("#phoneReg").css("display","block");
        $("#emailReg").css("display","none");
    }
    //邮箱注册
    function emailReg(cate){
        $(cate).addClass("f3");
        $(cate).prev().removeClass();
        $("#emailReg").css("display","block");
        $("#phoneReg").css("display","none");
    }
    /**
     * 发送手机验证码
     */
    function getPhoneVerify(){
        user=$.trim($("#prphone").val());//获取用户手机号
        var phoneVerify=function(){
            //获取手机验证码
            $.ajax({
                type: "POST",
                url:GET_PHONEVERIFY,
                data:"phone="+user,
                dataType:"json",
                success:function(data){
                    if(data.status=='0'){
                        alert(data.info);
                        return;
                    }else{
                        alert(data.info);
                        $('.width80').css("display","none");
                        $('.width97').removeAttr("style");
                        timerc = 60;
                        dtime();
                        return;
                    }
                }
            });
        }
        //检查手机号格式
        if(!user.match(/^1[3|4|5|7|8][0-9]\d{8}$/)){
            alert('对不起，请填写正确的手机号!');
            return;
        }else{
            //验证此手机是否已被注册
            $.ajax({
                type: "POST",
                url:CLICK_PHONE,
                data:"phone="+user,
                dataType:"text",
                success:function(data){
                    if(data==0){
                        alert('对不起，此手机已被注册，请更换!');
                        return;
                    }else{
                        phoneVerify();
                    }

                }
            });
        }
    }
    var timerc;
    function dtime(){
        if(timerc > 1){
            timerc=timerc-1;
            $("#dtime").text(timerc);
            setTimeout("dtime()", 1000); //设置1000毫秒以后执行一次本函数
        }else{
            $('.width97').css("display","none");
            $('.width80').removeAttr("style");
        }
    }
    //手机注册下一部
    function phoneNext(){
        user=$.trim($("#prphone").val());//获取用户手机号
        verify=$.trim($("#prverify").val());//获取手机验证码
        password=$.trim($("#prpassword").val());//获取密码
        password2=$.trim($("#prpassword2").val());//获取密码

        if(!user){
            alert('对不起，请输入手机号!');
            return;
        }
        //检查密码
        if(password=="" ||password.length<6 || password.length>20){
            alert('对不起，密码长度不正确!');
            return;
        }
        if(password2=="" ||password2.length<6 || password2.length>20){
            alert('对不起，确认密码长度不正确!');
            return;
        }
        if(password != password2){
            alert('两次输入密码不一致');
            return;
        }
        //检查验证码
        if(verify=="" ||verify.length!=6){
            alert('对不起，手机验证码长度不正确!');
            return;
        }
        //检查手机号格式
        if(!user.match(/^1[3|4|5|7|8][0-9]\d{8}$/)){
            alert('对不起，请填写正确的手机号!');
            return;
        }else{
            //验证手机
            $.ajax({
                type: "POST",
                url:CLICK_PHONEVER,
                data:"phone="+user+"&verify="+verify,
                dataType:"json",
                success:function(data){
                    if(data.status=='0'){
                        alert(data.info);
                        return;
                    }else{
                        type=2;
                        $(".loginbox").css("display","none");
                        $(".login_nextbox").css("display","block");
                    }
                }
            });
        }
    }
    //邮箱注册下一部
    function onemaliNext(){
        user=$.trim($("#erusername").val());//获取用户邮箱地址
        verify=$.trim($("#erverify").val());//获取验证码
        password=$.trim($("#erpasswrod").val());//获取密码
        password2=$.trim($("#erpasswrod2").val());//获取密码

        //检查邮箱
        if(user==""){
            alert('对不起，邮箱不能为空!');
            return;
        }
        if(!user.match(/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/)){
            alert('对不起，邮箱格式错误!');
            return;
        }else{
            //验证此邮箱是否已被注册
            $.ajax({
                type: "POST",
                url:CLICK_EMIL,
                data:"email="+user,
                dataType:"text",

                success:function(data){
                    if(data==0){
                        alert('对不起，此邮箱已被注册，请更换!');
                        return;
                    }else{
                        ckverify();
                    }

                }
            });

        }

        var ckpassword=function(){
            //检查密码
            if(password=="" ||password.length<6 || password.length>20){
                alert('对不起，密码长度不正确!');
                return;
            }
            if(password2=="" ||password2.length<6 || password2.length>20){
                alert('对不起，确认密码长度不正确!');
                return;
            }
            if(password != password2){
                alert('两次输入密码不一致');
                return;
            }
            type=1;//设置为邮箱注册状态
            $(".loginbox").css("display","none");
            $(".login_nextbox").css("display","block");
        };
        var ckverify = function(){
            //检查验证码
            if(verify=="" || verify.length !=5){
                alert('对不起，验证码长度不正确!');
                return;
            }else{
                $.ajax({
                    type: "POST",
                    url:CLICK_VERIFY,
                    data:"verify="+verify,
                    dataType:"text",
                    success:function(data){
                        if(data==0){
                            alert('对不起，验证码不正确!');
                            return;
                        }else{
                            ckpassword();
                        }
                    }
                });
            }
        };
    }
    //用户信息
    function setUserInfo(){
        var uname=$.trim($("#uname").val());//获取用户昵称
        var sex=$("#sex").val();//获取性别
        var profession=$("#profession").val();//取得职业信息
        var intro=$.trim($("#intro").val());//取得用户简介
        var interest=$.trim($("#interest").val());//取得感兴趣数据
//        var mhm_id=$.trim($("#mhm_id").val());//取得选择机构
        var city_names= $("input[name=city_names]").val();//地区信息
        var city_ids= $("input[name=city_ids]").val();//地区信息ids
        var province=$("#province").val();//取得省
        var city=$("#city").val();//取得市
        var area=$("#area").val();//取得区
        var mhm_id="{$Think.get.this_mhm_id}";//取得选择机构
        var ckemailreg=function(){
            if(province==0){//检查省
                alert('对不起，请选择地区所在省!');
                return;
            }
            if(city==0){//检查市
                alert('对不起，请选择所在城市!');
                return;
            }

            var udata;
            if(type==1){
                udata="&email="+user;
            }else{
                udata="&phone="+user;
            }
            $.ajax({
                async:false,
                type: "POST",
                url:REG_ADDRESS,
                data:"uname="+uname+"&sex="+sex+"&password="+password+"&profession="+profession+"&intro="+intro+"&interest="+interest+udata+"&city_names="+city_names+"&city_ids="+city_ids+"&type="+type+"&verify="+verify+"&mhm_id="+mhm_id,
                dataType:"json",
                success:function(data){
                    if(data.status== 0){
                        alert(data.info);
                        return;
                    }else{
                        alert('恭喜您，注册成功!');
                        window.location.href = data.data;
                    }
                }

            });
        }

        if(user=="" || password==""){
            return;
        }
        if(uname=="" || uname.length>6){
            //检查昵称
            alert('对不起，昵称长度不正确!');
            return;
        }else{
            $.ajax({
                type: "POST",
                url:CLICK_UNAME,
                data:"uname="+uname,
                dataType:"text",
                success:function(data){
                    if(data==0){
                        alert('对不起，此昵称已被注册，请更换!');
                        return;
                    }else{
                        ckemailreg();
                    }

                }
            });
        }
    }
    /**
     * 返回上一步
     */
    function prevBang(){
        $(".loginbox").css("display","block");
        $(".login_nextbox").css("display","none");
    }
</script>
